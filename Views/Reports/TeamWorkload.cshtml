@model dynamic
@{
    ViewData["Title"] = "Team Workload Metrics";
    var startDate = (DateTime)ViewBag.StartDate;
    var endDate = (DateTime)ViewBag.EndDate;
}

<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-1 fw-bold">
                <i class="bi bi-people text-gradient"></i> Team Workload Metrics
            </h2>
            <p class="text-muted mb-0">Analyze team performance and workload distribution</p>
        </div>
        <a href="/Reports/Analytics" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-1"></i> Back to Analytics
        </a>
    </div>
</div>

<!-- Period Info -->
<div class="alert alert-info border-0 shadow-sm mb-4">
    <div class="d-flex align-items-center">
        <i class="bi bi-calendar3 me-3" style="font-size: 1.5rem;"></i>
        <div>
            <strong>Report Period:</strong> @startDate.ToString("MMM dd, yyyy") - @endDate.ToString("MMM dd, yyyy")
        </div>
    </div>
</div>

<!-- Summary Card -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <p class="text-muted mb-1 small text-uppercase">Total Assigned Complaints</p>
                <h2 class="mb-0 fw-bold">@Model.TotalAssignedComplaints</h2>
                <small class="text-muted">Across all staff members</small>
            </div>
            <div class="icon-circle" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="bi bi-clipboard-check text-white" style="font-size: 2rem;"></i>
            </div>
        </div>
    </div>
</div>

<!-- Department Metrics -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white border-0 p-4">
        <h5 class="mb-0 fw-bold">
            <i class="bi bi-building text-primary me-2"></i> Department Performance
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="px-4 py-3 border-0">Department</th>
                        <th class="px-4 py-3 border-0 text-center">Total Assigned</th>
                        <th class="px-4 py-3 border-0 text-center">Staff Count</th>
                        <th class="px-4 py-3 border-0 text-center">Avg per Staff</th>
                        <th class="px-4 py-3 border-0 text-center">Resolved</th>
                        <th class="px-4 py-3 border-0 text-center">Resolution Rate</th>
                        <th class="px-4 py-3 border-0">Performance</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var dept in Model.DepartmentMetrics)
                    {
                        var rateColor = dept.ResolutionRate >= 80 ? "success" : dept.ResolutionRate >= 60 ? "warning" : "danger";
                        <tr>
                            <td class="px-4 py-3">
                                <span class="fw-semibold">@dept.DepartmentName</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge bg-primary">@dept.TotalAssigned</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge bg-info">@dept.StaffCount</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="text-muted">@dept.AvgWorkloadPerStaff</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge bg-success">@dept.Resolved</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge bg-@rateColor">@dept.ResolutionRate%</span>
                            </td>
                            <td class="px-4 py-3">
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-@rateColor" role="progressbar"
                                         style="width: @dept.ResolutionRate%"
                                         aria-valuenow="@dept.ResolutionRate" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Staff Metrics -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-0 p-4">
        <h5 class="mb-0 fw-bold">
            <i class="bi bi-person-badge text-primary me-2"></i> Individual Staff Performance
        </h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="px-4 py-3 border-0">Staff Member</th>
                        <th class="px-4 py-3 border-0">Department</th>
                        <th class="px-4 py-3 border-0 text-center">Total Assigned</th>
                        <th class="px-4 py-3 border-0 text-center">Pending</th>
                        <th class="px-4 py-3 border-0 text-center">In Progress</th>
                        <th class="px-4 py-3 border-0 text-center">Resolved</th>
                        <th class="px-4 py-3 border-0 text-center">Current Workload</th>
                        <th class="px-4 py-3 border-0 text-center">Avg Resolution (hrs)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var staff in Model.StaffMetrics)
                    {
                        var workloadColor = staff.CurrentWorkload > 10 ? "danger" : staff.CurrentWorkload > 5 ? "warning" : "success";
                        <tr>
                            <td class="px-4 py-3">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle me-3">
                                        @staff.StaffName.Substring(0, 1).ToUpper()
                                    </div>
                                    <span class="fw-semibold">@staff.StaffName</span>
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="text-muted small">@staff.DepartmentName</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge bg-primary">@staff.TotalAssigned</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge bg-warning">@staff.Pending</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge bg-info">@staff.InProgress</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge bg-success">@staff.Resolved</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="badge bg-@workloadColor">@staff.CurrentWorkload</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <span class="text-muted">@Math.Round(staff.AvgResolutionHours, 1)</span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Workload Distribution Chart -->
<div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-white border-0 p-4">
        <h5 class="mb-0 fw-bold">
            <i class="bi bi-bar-chart text-primary me-2"></i> Workload Distribution
        </h5>
    </div>
    <div class="card-body p-4">
        <canvas id="workloadChart" height="80"></canvas>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // Detect dark mode
        const isDarkMode = document.body.classList.contains('dark-mode');
        const textColor = isDarkMode ? '#ffffff' : '#666';
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const legendColor = isDarkMode ? '#ffffff' : '#666';
        const tooltipBg = isDarkMode ? 'rgba(30, 30, 30, 0.95)' : 'rgba(0, 0, 0, 0.8)';
        
        // Workload Chart
        const staffData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.StaffMetrics));
        
        const ctx = document.getElementById('workloadChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: staffData.map(s => s.staffName || s.StaffName),
                datasets: [
                    {
                        label: 'Pending',
                        data: staffData.map(s => s.pending || s.Pending || 0),
                        backgroundColor: 'rgba(255, 193, 7, 0.8)',
                        borderColor: 'rgb(255, 193, 7)',
                        borderWidth: 1
                    },
                    {
                        label: 'In Progress',
                        data: staffData.map(s => s.inProgress || s.InProgress || 0),
                        backgroundColor: 'rgba(13, 202, 240, 0.8)',
                        borderColor: 'rgb(13, 202, 240)',
                        borderWidth: 1
                    },
                    {
                        label: 'Resolved',
                        data: staffData.map(s => s.resolved || s.Resolved || 0),
                        backgroundColor: 'rgba(25, 135, 84, 0.8)',
                        borderColor: 'rgb(25, 135, 84)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: legendColor
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: tooltipBg,
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff'
                    }
                }
            }
        });
    </script>
}

<style>
    .icon-circle {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.1rem;
    }

    .text-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>
