@model dynamic
@{
    ViewData["Title"] = "Complaint Details";
    var userType = ViewBag.UserType;
    
    var statusClass = Model.Status == "Pending" ? "warning" :
                    Model.Status == "In Progress" ? "info" :
                    Model.Status == "Resolved" ? "success" : 
                    Model.Status == "Rejected" ? "danger" : "secondary";
    var priorityClass = Model.Priority == "High" ? "danger" :
                      Model.Priority == "Medium" ? "warning" : "info";
}

<div class="mb-4 d-print-none">
    <a href="/Complaint" class="btn btn-outline-secondary rounded-pill hover-lift">
        <i class="bi bi-arrow-left me-2"></i> Back to List
    </a>
</div>

<!-- Print Only Header -->
<div class="d-none d-print-block mb-4">
    <div class="d-flex justify-content-between align-items-center border-bottom pb-3">
        <div>
            <h1 class="h3 fw-bold mb-0">Complaint Management System</h1>
            <p class="text-muted mb-0">Complaint Details Report</p>
        </div>
        <div class="text-end">
            <p class="mb-0 text-muted small">Printed on: @DateTime.Now.ToString("dd MMM yyyy HH:mm")</p>
        </div>
    </div>
</div>

<div class="row">
    <!-- Main Content Column -->
    <div class="col-lg-8">
        <!-- Header Card -->
        <div class="card border-0 shadow-sm mb-4 animate-fade-in-up">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="flex-grow-1">
                        <div class="mb-2">
                            <span class="badge bg-light text-dark border me-2">
                                <i class="bi bi-tag-fill text-primary me-1"></i> @Model.CategoryName
                            </span>
                            <span class="badge bg-@statusClass-subtle text-@statusClass fw-semibold">
                                @Model.Status
                            </span>
                        </div>
                        <h2 class="mb-0 fw-bold">@Model.Title</h2>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-@priorityClass fs-6 px-3 py-2">
                            <i class="bi bi-exclamation-triangle me-1"></i> @Model.Priority
                        </span>
                    </div>
                </div>

                <div class="row g-3 text-muted small">
                    <div class="col-md-6">
                        <i class="bi bi-geo-alt text-primary me-2"></i>
                        <strong>Location:</strong> @Model.Location
                    </div>
                    <div class="col-md-6">
                        <i class="bi bi-person text-primary me-2"></i>
                        <strong>Submitted By:</strong> 
                        @if (Model.CitizenName == "Protected")
                        {
                            <span class="text-secondary">
                                <i class="bi bi-shield-lock me-1"></i>Protected
                            </span>
                        }
                        else
                        {
                            @Model.CitizenName
                        }
                    </div>
                    @if (Model.StaffName != "Unassigned")
                    {
                        <div class="col-md-12">
                            <i class="bi bi-person-badge text-primary me-2"></i>
                            <strong>Assigned to:</strong> @Model.StaffName
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Location Map Card -->
        @if (Model.Latitude != null && Model.Longitude != null)
        {
            <div class="card border-0 shadow-sm mb-4 animate-fade-in-up" style="animation-delay: 0.05s;">
                <div class="card-body p-0">
                    <div id="map" style="height: 300px; width: 100%; border-radius: 0.375rem;"></div>
                </div>
                <div class="card-footer bg-white border-0 pt-0">
                    <small class="text-muted"><i class="bi bi-geo-alt me-1"></i> @Model.Location</small>
                </div>
            </div>
        }

        <!-- Description Card -->
        <div class="card border-0 shadow-sm mb-4 animate-fade-in-up" style="animation-delay: 0.1s;">
            <div class="card-body p-4">
                <h5 class="fw-bold mb-3">
                    <i class="bi bi-card-text text-primary me-2"></i> Description
                </h5>
                <p class="text-muted mb-0" style="line-height: 1.8;">@Model.Description</p>
            </div>
        </div>

        <!-- Attachments -->
        @if (Model.Attachments != null && System.Linq.Enumerable.Any((IEnumerable<dynamic>)Model.Attachments))
        {
            <div class="card border-0 shadow-sm mb-4 animate-fade-in-up" style="animation-delay: 0.2s;">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-3">
                        <i class="bi bi-paperclip text-primary me-2"></i> Attachments
                        <span class="badge bg-light text-dark ms-2">@System.Linq.Enumerable.Count((IEnumerable<dynamic>)Model.Attachments)</span>
                    </h5>
                    @{ 
                        var imageAttachments = new List<dynamic>();
                        var otherAttachments = new List<dynamic>();
                        
                        foreach (var attachment in Model.Attachments)
                        {
                            if (attachment == null)
                            {
                                continue;
                            }
                            var ftObj = attachment.FileType;
                            var fpObj = attachment.FilePath;
                            var ft = ftObj as string;
                            var fp = fpObj as string;
                            if (!string.IsNullOrEmpty(ft) && ft.StartsWith("image/") && !string.IsNullOrEmpty(fp))
                            {
                                imageAttachments.Add(attachment);
                            }
                            else if (!string.IsNullOrEmpty(fp))
                            {
                                otherAttachments.Add(attachment);
                            }
                        }
                    }

                    @* Display Images *@
                    @if (imageAttachments.Count > 0)
                    {
                        <div class="row g-3 mb-3">
                            @foreach (var attachment in imageAttachments)
                            {
                                <div class="col-md-6">
                                    <div class="card border">
                                        <a href="@attachment.FilePath" target="_blank">
                                            <img src="@attachment.FilePath" alt="@System.IO.Path.GetFileName(attachment.FilePath)" 
                                                 class="card-img-top" style="max-height: 300px; object-fit: contain; background: #f8f9fa;" />
                                        </a>
                                        <div class="card-body p-2 text-center">
                                            <small class="text-muted text-truncate d-block">@System.IO.Path.GetFileName(attachment.FilePath)</small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }

                    @* Display Other File Types *@
                    @if (otherAttachments.Count > 0)
                    {
                        <div class="row g-3">
                            @foreach (var attachment in otherAttachments)
                            {
                                <div class="col-md-6">
                                    <a href="@attachment.FilePath" target="_blank" 
                                       class="card border hover-lift text-decoration-none h-100">
                                        <div class="card-body d-flex align-items-center p-3">
                                            <div class="me-3">
                                                <i class="bi bi-file-earmark-text text-primary" style="font-size: 2rem;"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <p class="mb-0 fw-semibold text-dark text-truncate">
                                                    @System.IO.Path.GetFileName(attachment.FilePath)
                                                </p>
                                                <small class="text-muted">@attachment.FileType</small>
                                            </div>
                                            <i class="bi bi-download text-primary"></i>
                                        </div>
                                    </a>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Status History Timeline -->
        @if (Model.History != null && System.Linq.Enumerable.Any((IEnumerable<dynamic>)Model.History))
        {
            <div class="card border-0 shadow-sm mb-4 animate-fade-in-up" style="animation-delay: 0.3s;">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4">
                        <i class="bi bi-clock-history text-primary me-2"></i> Status History
                    </h5>
                    <div class="timeline">
                        @foreach (var history in Model.History)
                        {
                            if (history == null)
                            {
                                continue;
                            }
                            <div class="timeline-item">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <span class="badge bg-secondary me-2">@history.StatusBefore</span>
                                            <i class="bi bi-arrow-right text-muted mx-1"></i>
                                            <span class="badge bg-info">@history.StatusAfter</span>
                                        </div>
                                        <small class="text-muted">@((history.ChangeTime is DateTime hdt) ? hdt.ToString("dd MMM yyyy HH:mm") : (history.ChangeTime != null ? history.ChangeTime.ToString() : ""))</small>
                                    </div>
                                    @if (!string.IsNullOrEmpty(history.Notes))
                                    {
                                        <div class="alert alert-light border small mb-0 p-2 text-muted">
                                            <i class="bi bi-sticky me-1"></i> @history.Notes
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Feedback Section -->
        @if (Model.Feedback != null && System.Linq.Enumerable.Any((IEnumerable<dynamic>)Model.Feedback))
        {
            <div class="card border-0 shadow-sm mb-4 animate-fade-in-up" style="animation-delay: 0.4s;">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4">
                        <i class="bi bi-star-fill text-warning me-2"></i> Feedback
                        <span class="badge bg-light text-dark ms-2">@System.Linq.Enumerable.Count((IEnumerable<dynamic>)Model.Feedback)</span>
                    </h5>
                    @foreach (var feedback in Model.Feedback)
                    {
                        if (feedback == null)
                        {
                            continue;
                        }
                        var ratingObj = feedback.Rating;
                        var rating = ratingObj is int r ? r : 0;
                        if (rating < 0) { rating = 0; }
                        if (rating > 5) { rating = 5; }
                        <div class="card border mb-3">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        @for (int i = 0; i < rating; i++)
                                        {
                                            <i class="bi bi-star-fill text-warning"></i>
                                        }
                                        @for (int i = rating; i < 5; i++)
                                        {
                                            <i class="bi bi-star text-muted"></i>
                                        }
                                        <span class="ms-2 text-muted small">(@rating/5)</span>
                                    </div>
                                    <small class="text-muted">
                                        <i class="bi bi-calendar me-1"></i>
                                        @((feedback.CreatedAt is DateTime fdt) ? fdt.ToString("dd MMM yyyy") : (feedback.CreatedAt != null ? feedback.CreatedAt.ToString() : ""))
                                    </small>
                                </div>
                                <p class="mb-0 text-muted">@(feedback.Comment ?? "")</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>

    <!-- Sidebar Column -->
    <div class="col-lg-4">
        <!-- Info Card -->
        <div class="card border-0 shadow-sm mb-4 animate-fade-in-up" style="animation-delay: 0.1s;">
            <div class="card-body p-4">
                <h6 class="fw-bold mb-3 text-uppercase small text-muted">Timeline</h6>
                
                <div class="mb-3 pb-3 border-bottom">
                    <small class="text-muted d-block mb-1">Submitted</small>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-calendar-plus text-primary me-2"></i>
                        <strong>@((Model.SubmittedAt is DateTime sdt) ? sdt.ToString("dd MMM yyyy HH:mm") : (Model.SubmittedAt != null ? Model.SubmittedAt.ToString() : "-"))</strong>
                    </div>
                </div>

                <div class="mb-3 pb-3 border-bottom">
                    <small class="text-muted d-block mb-1">Last Updated</small>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-calendar-check text-primary me-2"></i>
                        <strong>@((Model.UpdatedAt is DateTime udt) ? udt.ToString("dd MMM yyyy HH:mm") : (Model.UpdatedAt != null ? Model.UpdatedAt.ToString() : "-"))</strong>
                    </div>
                </div>

                @if (Model.ResolvedAt != null)
                {
                    <div>
                        <small class="text-muted d-block mb-1">Resolved</small>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            <strong>@((Model.ResolvedAt is DateTime rdt) ? rdt.ToString("dd MMM yyyy HH:mm") : (Model.ResolvedAt != null ? Model.ResolvedAt.ToString() : "-"))</strong>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Actions Card -->
        <div class="card border-0 shadow-sm mb-4 animate-fade-in-up d-print-none" style="animation-delay: 0.2s;">
            <div class="card-body p-4">
                <h6 class="fw-bold mb-3 text-uppercase small text-muted">Actions</h6>
                
                @if (userType == "Citizen" && Model.Status == "Pending")
                {
                    <a href="/Complaint/Edit/@Model.ComplaintId" class="btn btn-primary w-100 mb-2 hover-lift">
                        <i class="bi bi-pencil-square me-2"></i> Edit Complaint
                    </a>
                }

                @if ((userType == "Staff" || userType == "Admin") && Model.Status != "Resolved" && Model.Status != "Rejected" && Model.Status != "Closed - Duplicate")
                {
                    <a href="/Complaint/Update/@Model.ComplaintId" class="btn btn-success w-100 mb-2 hover-lift">
                        <i class="bi bi-pencil me-2"></i> Update Status
                    </a>
                }
                
                @if (userType == "Citizen" && (Model.Status == "Resolved" ))
                {
                    <a href="/Feedback/Submit/@Model.ComplaintId" class="btn btn-warning w-100 mb-2 hover-lift">
                        <i class="bi bi-star me-2"></i> Submit Feedback
                    </a>
                }

                <button onclick="window.open('/Complaint/PrintDetails/@Model.ComplaintId', '_blank', 'width=1000,height=800,scrollbars=yes,resizable=yes');" class="btn btn-outline-secondary w-100 mb-3">
                    <i class="bi bi-printer me-2"></i> Print Details
                </button>

                @if (userType == "Staff" || userType == "Admin")
                {
                    <!-- Case Management Actions -->
                    <hr class="my-3" />
                    <h6 class="fw-bold mb-3 text-uppercase small text-muted">Case Management</h6>
                    
                    <a href="/Complaint/PotentialDuplicates/@Model.ComplaintId" class="btn btn-outline-warning w-100 mb-2">
                        <i class="bi bi-search me-2"></i> Check for Duplicates
                    </a>

                    <a href="/Complaint/LinkedComplaints/@Model.ComplaintId" class="btn btn-outline-info w-100 mb-2">
                        <i class="bi bi-link-45deg me-2"></i> View Linked Complaints
                    </a>
                }

                @if (userType == "Admin")
                {
                    <!-- Admin Only Actions -->
                    <hr class="my-3" />
                    <h6 class="fw-bold mb-3 text-uppercase small text-muted">Admin Actions</h6>
                    
                    <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="bi bi-trash me-2"></i> Delete Complaint
                    </button>
                }
            </div>
        </div>

        <!-- Contact Support -->
        <div class="alert alert-info border-0 animate-fade-in-up d-print-none" style="animation-delay: 0.3s;">
            <h6 class="fw-bold mb-2">
                <i class="bi bi-info-circle me-2"></i> Need Help?
            </h6>
            <p class="small mb-2">If you have questions about this complaint, contact our support team.</p>
            <a asp-controller="Contact" asp-action="Index" class="btn btn-sm btn-info">Contact Support</a>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
@if (userType == "Admin")
{
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white border-0">
                    <h5 class="modal-title" id="deleteModalLabel">
                        <i class="bi bi-exclamation-triangle me-2"></i> Confirm Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <p class="mb-3">Are you sure you want to delete this complaint?</p>
                    <div class="alert alert-warning border-0">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone. All associated data including attachments, history, notifications, and feedback will be permanently deleted.
                    </div>
                    <p class="mb-0 text-muted small">
                        <strong>Complaint ID:</strong> @Model.ComplaintId<br />
                        <strong>Title:</strong> @Model.Title
                    </p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form asp-action="Delete" asp-route-id="@Model.ComplaintId" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash me-2"></i> Delete Permanently
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}


@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var lat = @(Model.Latitude ?? "null");
            var lng = @(Model.Longitude ?? "null");
            
            if (lat !== null && lng !== null) {
                var map = L.map('map').setView([lat, lng], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                L.marker([lat, lng]).addTo(map)
                    .bindPopup('@Html.Raw(Model.Title)')
                    .openPopup();
            }
        });
    </script>
}

@section Styles {
<link rel="stylesheet" href="~/css/complaint.details.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
}

